<?php
require("includes.php");
$database = new Database($config, "anope");
$aDb = $database->getConnection();
$database = new Database($config);
$db = $database->getConnection();
$smarty->assign('fullurl', $config->getFullUrl());
$login = new Login();
$id = $login->getSession();
$smarty->assign('page','list');//default

if ($id) {
    $member = new Member($aDb);
    $member->getById($id);
    
    $isGodUser = $member->isGodUser();
    if ($isGodUser) {
        $smarty->assign('god', "true");
    }
    
    $smarty->assign('login',$member->getUsername());
    
    $page = 'list';
    if (isset($_GET['page'])) {
        $page = $_GET['page'];
    }
    if ($page == "transfer") {
        if (isset($_POST['username'])) {
            $cId = $_POST['chat_id'];
            $chat = new Chatbox($db);
            if ($chat->getById($cId)) {
                if (($chat->getOwner() == $id) || ($isGodUser)) {
                    $newowner = new Member($aDb);
                    if ($newowner->getByUsername($_POST['username'])) {
                        $chat->setOwner($newowner->getId());
                        if($chat->transfer()) {
                            $smarty->assign('info',"Je chatbox is succesvol overgedragen aan: <strong>".$newowner->getUsername()."</strong>!");
                        }
                        else {
                            $smarty->assign('error',"Er is wat misgelopen.");
                        }
                    }
                    else {
                        $smarty->assign('error',"De gebruiker aan wie je je chatbox wil overdragen bestaat niet.");
                    }
                }
                else {
                    $smarty->assign('error',"Er is wat misgelopen.");
                }
            }
            else {
                $smarty->assign('error',"Er is wat misgelopen.");
            }
        }
        else {
            if (isset($_GET['id'])) {
                $cId = $_GET['id'];
                $chat = new Chatbox($db);
                if ($chat->getById($cId)) {
                    if (($chat->getOwner() == $id) || ($isGodUser)) {
                        $smarty->assign('chat_id',$cId);
                        $smarty->assign('page',"transfer");
                    }
                    else {
                        $smarty->assign('error',"Er is wat misgelopen.");
                    }    
                }
                else {
                    $smarty->assign('error',"Er is wat misgelopen.");
                }
            }          
        }
    }
    elseif ($page == "del") {
        if (isset($_POST['chat_id'])) {
            $cId = $_POST['chat_id'];
            
            $chat = new Chatbox($db);
            if ($chat->getById($cId)) {
                
                if (($chat->getOwner() == $id) || ($isGodUser)) {
                    
                    if ($chat->disable()) {
                        $smarty->assign('success',"Je chatbox is verwijderd.");
                    }
                    else {
                        $smarty->assign('error',"Er is wat misgelopen.");
                    }
                }
                else {
                    $smarty->assign('error',"Er is wat misgelopen.");
                }
            }
            else {
                $smarty->assign('error',"Er is wat misgelopen.");
            }
        }
        elseif (isset($_GET['id'])) {
            $cId = $_GET['id'];
            
            $chat = new Chatbox($db);
            if ($chat->getById($cId)) {
                
                if (($chat->getOwner() == $id) || ($isGodUser)) {
                    
                    $smarty->assign('chat_id', $cId);
                    $smarty->assign('chat_name', $chat->getName());
                    
                    $member = new Member($aDb);
                    if ($member->getById($chat->getOwner())) {
                        $smarty->assign('chat_owner', $member->getUsername());
                        $smarty->assign('page', "del");
                    }
                    else {
                        $smarty->assign('error',"Er is wat misgelopen.");
                    }
                }
                else {
                    $smarty->assign('error',"Er is wat misgelopen.");
                }
            }
            else {
                $smarty->assign('error',"Er is wat misgelopen.");
            }
        }
    }
    elseif ($page == "edit") {
        if (isset($_POST['chat_id'])) {
            $cId = $_POST['chat_id'];
            $chat = new Chatbox($db);
            if ($chat->getById($cId)) {
                if (($chat->getOwner() == $id) || ($isGodUser)) {
                    //Chatnaam
                    if (isset($_POST['chat_name'])) {
                        $chat->setName(str_replace('#', '', $_POST['chat_name']));
                    }
                    //Chatstijl
                    if (isset($_POST['chat_style'])) {
                        $chat->setStyle($_POST['chat_style']);
                    }
                    //Iconstijl
                    if (isset($_POST['icon_style'])) {
                        $chat->setIconStyle($_POST['icon_style']);
                    }
                    //Moeten icoontjes als nick prefix in de chat gebruikt worden?
                    if (isset($_POST['icon_prefix'])) {
                        $chat->LightIRC->setShowNickprefixIcons("true");
                    }
                    else {
                        $chat->LightIRC->setShowNickprefixIcons("false");
                    }
                    //Moet er een timestamp getoond worden?
                    if (isset($_POST['timestamp'])) {
                        $chat->LightIRC->setShowTimestamps("true");
                    }
                    else {
                        $chat->LightIRC->setShowTimestamps("false");
                    }
                    //Webcam instellingen
                    $webcam_audio = false;
                    $webcam_video = false;
                    $webcam_prive = false;
                    if (isset($_POST['webcam_video'])) {
                        $webcam_video = $_POST['webcam_video'];
                    }
                    if (isset($_POST['webcam_audio'])) {
                        $webcam_audio = $_POST['webcam_audio'];
                    }
                    if (isset($_POST['webcam_prive'])) {
                        $webcam_prive = $_POST['webcam_prive'];
                    }
                    if (($webcam_audio) || ($webcam_video)) {
                        $chat->enableWebcam();
                        if (!$webcam_audio) {
                            $chat->webcamEnableVideoOnly();
                        }
                        if (!$webcam_video) {
                            $chat->webcamEnableAudioOnly();
                        }
                    }
                    else {
                        $chat->disableWebcam();
                    }
                    if ($webcam_prive) {
                        $chat->LightIRC->setWebcamPublicOnly("false");
                    }
                    else {
                        $chat->LightIRC->setWebcamPublicOnly("true");
                    }
                    //Privegesprekken?
                    if (isset($_POST['chat_prive'])) {
                        $chat->enableQueries();
                    }
                    else {
                        $chat->disableQueries();
                    }
                    //Server window
                    if (isset($_POST['serverwindow'])) {
                        $chat->LightIRC->setShowServerWindow("true");
                    }
                    else {
                        $chat->LightIRC->setShowServerWindow("false");
                    }
                    //Kanaallijst button
                    if (isset($_POST['channellist'])) {
                        $chat->LightIRC->setShowListButton("true");
                    }
                    else {
                        $chat->LightIRC->setShowListButton("false");
                    }
                    //Tekst vetgedrukt en onderlijnd toelaten
                    if (isset($_POST['textstyling'])) {
                        $chat->LightIRC->setShowRichTextControlsForegroundColor("true");
                        $chat->LightIRC->setShowRichTextControlsBackgroundColor("true");
                        $chat->LightIRC->setShowRichTextControls("true");
                    }
                    else {
                        $chat->LightIRC->setShowRichTextControlsForegroundColor("false");
                        $chat->LightIRC->setShowRichTextControlsBackgroundColor("false");
                        $chat->LightIRC->setShowRichTextControls("false");
                    }
                    //Hostmask bij joins, parts, quits
                    if (isset($_POST['verboseinformation'])) {
                        $chat->LightIRC->setShowVerboseUserInformation("true");
                    }
                    else {
                        $chat->LightIRC->setShowVerboseUserInformation("false");
                    }
                    //Radioplayer instellingen
                    if ((isset($_POST['radio_name'])) && (isset($_POST['radio_url'])) && (isset($_POST['radio_port']))) {
                        if ((strlen($_POST['radio_name']) > 0) && (strlen($_POST['radio_url']) > 0) && (strlen($_POST['radio_port']) > 0)) {
                            $chat->setRadioName($_POST['radio_name']);
                            $chat->setRadioUrl($_POST['radio_url']);
                            $chat->setRadioPort($_POST['radio_port']);
                            $chat->setHeight("90");
                        }
                        else {
                            $chat->setRadioName(null);
                            $chat->setRadioUrl(null);
                            $chat->setRadioPort(null);
                            $chat->setHeight("100");
                        }
                    }
                    else {
                        $chat->setRadioName(null);
                        $chat->setRadioUrl(null);
                        $chat->setRadioPort(null);
                        $chat->setHeight("100");
                    }
                    //Radio player type
                    if (isset($_POST['radio_style'])) {
                        $chat->setRadioStyle($_POST['radio_style']);
                    }

                    $chat->update();
                    $smarty->assign('success',"Je chatbox is opgeslagen!");
                    $smarty->assign('page',"list");
                }
                else {
                    $smarty->assign('error',"Er is wat misgelopen.");
                }
            }
            else {
                $smarty->assign('error',"Er is wat misgelopen.");
            }
        }
        elseif (isset($_GET['id'])) {
            $cId = $_GET['id'];
            $chat = new Chatbox($db);
            if ($chat->getById($cId)) {
                if (($chat->getOwner() == $id) || ($isGodUser)) {
                    $smarty->assign('chat_id',$cId);
                    //Chatname
                    $chat_name = $chat->getName();
                    if($chat_name) {
                        $smarty->assign('chat_name',$chat_name);
                    }
                    //Chatstyle
                    $chat_style = $chat->getStyle();
                    if ($chat_style) {
                        $smarty->assign('chat_style',$chat_style);
                    }
                    //Iconstyle
                    $icon_style = $chat->getIconStyle();
                    if ($icon_style) {
                        $smarty->assign('icon_style',$icon_style);
                    }
                    //Iconprefix
                    $icon_prefix = $chat->LightIRC->getShowNickprefixIcons();
                    if ($icon_prefix == "true") {
                        $smarty->assign('icon_prefix', "true");
                    }
                    else {
                        $smarty->assign('icon_prefix', "false");
                    }
                    //Timestamp
                    $timestamp = $chat->LightIRC->getShowTimestamps();
                    if ($timestamp == "true") {
                        $smarty->assign('timestamp', "true"); 
                    }
                    else {
                        $smarty->assign('timestamp', "false");
                    }
                    //Webcam
                    $webcam = $chat->LightIRC->getWebcam();
                    $webcamvonly = $chat->LightIRC->getWebcamVideoOnly();
                    $webcamaonly = $chat->LightIRC->getWebcamAudioOnly();
                    if (($webcam == "true") && ($webcamaonly != "true")) {
                        $smarty->assign('webcam_video',"true");
                    }
                    else {
                        $smarty->assign('webcam_video',"false");
                    }
                    if (($webcam == "true") && ($webcamvonly != "true")) {
                        $smarty->assign('webcam_audio',"true");
                    }
                    else {
                        $smarty->assign('webcam_audio',"false");
                    }
                    if ($chat->LightIRC->getWebcamPublicOnly() == "false") {
                        $smarty->assign('webcam_prive',"true");
                    }
                    else {
                        $smarty->assign('webcam_prive',"false");
                    }
                    //Chat_Prive
                    $chat_prive = $chat->LightIRC->getEnableQueries();
                    if ($chat_prive == "true") {
                        $smarty->assign('chat_prive', "true");
                    }
                    else {
                        $smarty->assign('chat_prive', "false");
                    }
                    //Server window
                    $serverwindow = $chat->LightIRC->getShowServerWindow();
                    if ($serverwindow == "true") {
                        $smarty->assign('serverwindow', "true");
                    }
                    else {
                        $smarty->assign('serverwindow',"false");
                    }
                    //Channel list
                    $channellist = $chat->LightIRC->getShowListButton();
                    if ($channellist == "true") {
                        $smarty->assign('channellist', "true");
                    }
                    else {
                        $smarty->assign('channellist', "false");
                    }
                    //Colors
                    $textstyling = $chat->LightIRC->getShowRichTextControls();
                    if ($textstyling == "true") {
                        $smarty->assign('textstyling', "true");
                    }
                    else {
                        $smarty->assign('textstyling', "false");
                    }
                    //Join,Part,Quit host
                    $verboseinformation = $chat->LightIRC->getShowVerboseUserInformation();
                    if ($verboseinformation == "true") {
                        $smarty->assign('verboseinformation', "true");
                    }
                    else {
                        $smarty->assign('verboseinformation', "false");
                    }
                    //Radio
                    $radio_name = $chat->Radio->getName();
                    if ($radio_name) {
                        $smarty->assign('radio_name', $radio_name);
                    }
                    $radio_url = $chat->Radio->getStreamUrl();
                    if ($radio_url) {
                        $smarty->assign('radio_url', $radio_url);
                    }
                    $radio_port = $chat->Radio->getStreamPort();
                    if ($radio_port) {
                        $smarty->assign('radio_port', $radio_port);
                    }
                    $radio_type = $chat->Radio->getPlayer();
                    if ($radio_type) {
                        $smarty->assign('radio_style', $radio_type);
                    }
                    $smarty->assign('page','edit');
                }
                else {
                    $smarty->assign('error',"Er is wat misgelopen.");
                }
            }
            else {
                $smarty->assign('error',"Er is wat misgelopen.");
            }
        }
    }
    elseif ($page == "new") {
        if (isset($_POST['chat_name'])) {
            $chat = new Chatbox($db);
            $chat->setOwner($id);
            //Chatnaam
            if (isset($_POST['chat_name'])) {
                $chat->setName(str_replace('#', '', $_POST['chat_name']));
            }
            //Chatstijl
            if (isset($_POST['chat_style'])) {
                $chat->setStyle($_POST['chat_style']);
            }
            //Iconstijl
            if (isset($_POST['icon_style'])) {
                $chat->setIconStyle($_POST['icon_style']);
            }
            //Moeten icoontjes als nick prefix in de chat gebruikt worden?
            if (isset($_POST['icon_prefix'])) {
                $chat->LightIRC->setShowNickprefixIcons("true");
            }
            else {
                $chat->LightIRC->setShowNickprefixIcons("false");
            }
            //Moet er een timestamp getoond worden?
            if (isset($_POST['timestamp'])) {
                $chat->LightIRC->setShowTimestamps("true");
            }
            else {
                $chat->LightIRC->setShowTimestamps("false");
            }
            //Webcam instellingen
            $webcam_audio = false;
            $webcam_video = false;
            $webcam_prive = false;
            if (isset($_POST['webcam_video'])) {
                $webcam_video = $_POST['webcam_video'];
            }
            if (isset($_POST['webcam_audio'])) {
                $webcam_audio = $_POST['webcam_audio'];
            }
            if (isset($_POST['webcam_prive'])) {
                $webcam_prive = $_POST['webcam_prive'];
            }
            if (($webcam_audio) || ($webcam_video)) {
                $chat->enableWebcam();
                if (!$webcam_audio) {
                    $chat->webcamEnableVideoOnly();
                }
                if (!$webcam_video) {
                    $chat->webcamEnableAudioOnly();
                }
            }
            else {
                $chat->disableWebcam();
            }
            if ($webcam_prive) {
                $chat->LightIRC->setWebcamPublicOnly("false");
            }
            else {
                $chat->LightIRC->setWebcamPublicOnly("true");
            }
            //Privegesprekken?
            if (isset($_POST['chat_prive'])) {
                $chat->enableQueries();
            }
            else {
                $chat->disableQueries();
            }
            //Server window
            if (isset($_POST['serverwindow'])) {
                $chat->LightIRC->setShowServerWindow("true");
            }
            else {
                $chat->LightIRC->setShowServerWindow("false");
            }
            //Kanaallijst button
            if (isset($_POST['channellist'])) {
                $chat->LightIRC->setShowListButton("true");
            }
            else {
                $chat->LightIRC->setShowListButton("false");
            }
            //Tekst vetgedrukt en onderlijnd toelaten
            if (isset($_POST['textstyling'])) {
                $chat->LightIRC->setShowRichTextControlsForegroundColor("true");
                $chat->LightIRC->setShowRichTextControlsBackgroundColor("true");
                $chat->LightIRC->setShowRichTextControls("true");
            }
            else {
                $chat->LightIRC->setShowRichTextControlsForegroundColor("false");
                $chat->LightIRC->setShowRichTextControlsBackgroundColor("false");
                $chat->LightIRC->setShowRichTextControls("false");
            }
            //Hostmask bij joins, parts, quits
            if (isset($_POST['verboseinformation'])) {
                $chat->LightIRC->setShowVerboseUserInformation("true");
            }
            else {
                $chat->LightIRC->setShowVerboseUserInformation("false");
            }
            //Radioplayer instellingen
            if ((isset($_POST['radio_name'])) && (isset($_POST['radio_url'])) && (isset($_POST['radio_port']))) {
                $chat->setRadioName($_POST['radio_name']);
                $chat->setRadioUrl($_POST['radio_url']);
                $chat->setRadioPort($_POST['radio_port']);
                $chat->setHeight("90");
            }
            //Radio player type
            if (isset($_POST['radio_style'])) {
                $chat->setRadioStyle($_POST['radio_style']);
            }
            
            $chat->save();
            $smarty->assign('success',"Je chatbox is aangemaakt!");
            $smarty->assign('page',"list");
        }
        else {
            //Formulier nieuwe chat aanmaken
            $smarty->assign('page','new');
        }
    }
    elseif ($page == "help") {
        $smarty->assign('page',"help");
    }
    elseif ($page == "settings") {
        $smarty->assign('page',"settings");
    }
    else {
        //Geen page opgegeven
    }
    
    if ($isGodUser > 0) {
        
        $member = new Member($db);
        $chatboxes = $member->getAllGodChatboxes();
        $ids = array();
        $owners = array();
        $calls = array();
        $lastcalleds = array();
        $names = array();
        foreach ($chatboxes as $chatbox) {
            $owner = new Member($aDb);
            $owner->getById($chatbox->getOwner());
            array_push($ids,$chatbox->getId());
            array_push($owners,$owner->getUsername());
            array_push($calls, $chatbox->getCalls());
            array_push($lastcalleds, $chatbox->getLastCalled());
            array_push($names,$chatbox->getName());
        }
        $smarty->assign('ids',$ids);
        $smarty->assign('owners', $owners);
        $smarty->assign('calls', $calls);
        $smarty->assign('lastcalleds', $lastcalleds);
        $smarty->assign('names', $names);
    }
    else {
        $member = new Member($db);
        $chatboxes = $member->getAllChatboxes($id);        
        $ids = array();
        $owners = array();
        $names = array();
        foreach ($chatboxes as $chatbox) {
            array_push($ids, $chatbox->getId());
            array_push($names, $chatbox->getName());
        }
        $smarty->assign('ids', $ids);
        $smarty->assign('names', $names);
    }
    
    $smarty->display('mainpanel.tpl');
    
    

}
else {
    $smarty->assign('error', "Gelieve eerst in te loggen");
    $smarty->display('login.tpl');
}
?>
